<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Netzbremse Dashboard</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
  body { margin: 0; font-family: sans-serif; }
  .chart { width: 100%; height: 45vh; }
</style>
</head>
<body>

<h2>Netzbremse Dashboard</h2>

<div id="g1" class="chart"></div>
<div id="g2" class="chart"></div>
<div id="g3" class="chart"></div>
<div id="g4" class="chart"></div>

<script>
const colors = {
  t0: "#1f77b4", t1: "#ff7f0e", t2: "#2ca02c",
  t3: "#d62728", t4: "#9467bd", t5: "#8c564b"
};

// Set here your Up- and Downstream
// For example: I have a 600/300 Down-/Upstream.
// It will show a green area on the graph around this Down-/Upstream
const download = 600
const upload = 300
const bits_to_megabits_multiplicator = 1000 * 1000
const download_upper_limit = download + 50
const download_lower_limit = download - 50 
const upload_upper_limit = upload + 50 
const upload_lower_limit = upload - 50  

fetch("/data").then(r => r.json()).then(data => render(data));

function render(data) {
  const runs = Object.keys(data).sort();
  const eps = Object.keys(colors);

  function traces(metric, label, symbol) {
    return eps.map(ep => ({
      x: runs,
      y: runs.map(r => data[r][ep]?.[metric] ?? null),
      mode: "lines+markers",
      connectgaps: true,
      name: `${ep} ${label}`,
      line: { color: colors[ep] },
      marker: { symbol: symbol, size: 8 },
      hovertemplate: `${ep} ${label}<br>%{x}<br>%{y}<extra></extra>`
    }));
  }

  // Download & Upload Graph
  const dl_ul_traces = [
    ...traces("download", "Download", "circle"),
    ...traces("upload", "Upload", "triangle-up")
  ];

  const dl_ul_layout = {
    title: "Download & Upload",
    shapes: [
      {
        type: 'rect', xref: 'paper', x0: 0, x1: 1,
        yref: 'y', y0: download_lower_limit * bits_to_megabits_multiplicator, y1: download_upper_limit * bits_to_megabits_multiplicator,
        fillcolor: 'rgba(0,255,0,0.1)',
        line: { width: 0 }
      },
      {
        type: 'rect', xref: 'paper', x0: 0, x1: 1,
        yref: 'y', y0: upload_lower_limit * bits_to_megabits_multiplicator, y1: upload_upper_limit * bits_to_megabits_multiplicator,
        fillcolor: 'rgba(0,255,0,0.1)',
        line: { width: 0 }
      }
    ],
    annotations: [
      {
        xref: 'paper', x: 0.5, y: download * bits_to_megabits_multiplicator,
        text: 'Normbereich Download',
        showarrow: false,
        font: { color: 'green', size: 12 }
      },
      {
        xref: 'paper', x: 0.5, y: upload * bits_to_megabits_multiplicator,
        text: 'Normbereich Upload',
        showarrow: false,
        font: { color: 'green', size: 12 }
      }
    ]
  };

  Plotly.newPlot("g1", dl_ul_traces, dl_ul_layout, { responsive: true });

  // Andere Graphen bleiben unver√§ndert
  Plotly.newPlot("g2", [
    ...traces("latency", "Latency", "square"),
    ...traces("jitter", "Jitter", "diamond")
  ], { title: "Latency & Jitter" }, { responsive: true });

  Plotly.newPlot("g3", [
    ...traces("downLoadedLatency", "DL Latency", "square"),
    ...traces("upLoadedLatency", "UL Latency", "triangle-up")
  ], { title: "Download / Upload Latency" }, { responsive: true });

  Plotly.newPlot("g4", [
    ...traces("downLoadedJitter", "DL Jitter", "diamond"),
    ...traces("upLoadedJitter", "UL Jitter", "triangle-up")
  ], { title: "Download / Upload Jitter" }, { responsive: true });
}
</script>

</body>
</html>